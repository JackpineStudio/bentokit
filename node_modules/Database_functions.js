/**
 * Database_functions.js
 * This module contains functions needed to access the database 
 */

var mysql = require('mysql'),
	Logger = require('./Logger.js'),
	fs = require("fs"),
	AppObject = require('AppObject.js');
var connectionDetails = {};
var crypto = require("crypto");
var apps;

connectionDetails['host'] = "127.0.0.1";
connectionDetails['user'] = "root";
connectionDetails['password'] = "password";
connectionDetails['database'] = "bentokit-database";

var connectionMade = false;
var logFile = "./logs/run.log";
var pool = null;
var usePool = false;
Logger.setLogFile(logFile);

function getConnectionDetails(file) {
	fs.readFile(file, 'utf8', function(err, data) {
		if(err) {
			//use defaultConnectionDetails
			if(usePool) {
				createPool();
			}
		} else {
			var lines = data.split("\n");
			for (var i = 0; i < lines.length; i++) {
				var string = lines[i].split(":");
				var key = string[0];
				var value = string[1];
				connectionDetails[key] = value;
			}
			
		}
	});
	
	var interval = 1 * 1000;
	var intervalFn = null;
	intervalFn = setInterval(function(){
		if(connectionDetails['usePool'] == 'true') {
			usePool = true;
			createPool();
		}
		clearInterval(intervalFn);
	}, interval);
	
	
}

exports.setConnectionDetails = function(settings) {
	setConnectionDetails(settings);
	Logger.log(0, 'New connection details ' + settings);
};

function setConnectionDetails(settings) {
	connectionDetails = settings;
}

function createPool() {
	Logger.log(0, "Creating pool");
	if (pool == null) {
		pool = mysql.createPool({
			host : connectionDetails['host'],
			user : connectionDetails['user'],
			password : connectionDetails['password'],
			database : connectionDetails['database']
		});
		pool.on('connection', function(connection){
			Logger.log(0, "Created pool succesfully!");
		});
	}	
}

/*
 * This function creates a new connection to the database.
 * Connection details are provided from the map connectionDetails
 */
function connectToDatabase() {
	var connection;
	Logger.log(0, 'Creating connection to the databsase');
	connection = mysql.createConnection({
		host : connectionDetails['host'],
		user : connectionDetails['user'],
		password : connectionDetails['password'],
		database : connectionDetails['database']
	});
	connection.connect(function (err){
		connection.on('err', function() {
			Logger.log(-1,'Cannot connect to the database');
		});
		connectionMade = true;
		connection.setMaxListeners(200);
	});
	return connection;
}
/*
 * This function executes a query that gets the Count(*) from SaleObjects table
 */
function getCount(connection) {
	if (connection == null)
		connectToDatabase();
	Logger.log(0, 'Getting count from the database');
	var sqlQuery = 'SELECT count(*) FROM apps';	
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	var count = 0;
	query
	.on('result', function(row) {
		count = row['count(*)'];
	})
	.on('end', function() {
		console.log(count);
		// closeConnection();
		return count;
	});	
}


/*
 * This function checks whether the object is in the database or not
 * arguments:
 * 	object - SaleObject
 */
function exists(object) {
	var sqlQuery = 'SELECT count(*) FROM apps WHERE link = ?';
	var query = connection.query(sqlQuery, [object.link]);
	Logger.log(0, "Executing query '" + query.sql + "'");
	var count = -1;
	query
	.on('result', function(row){
		count = row['count(*)'];
	})
	.on('end', function() {
		if (count != 0)
			exists =  true;
		exists =  false;
		closeConnection(connection);
	});	
}

/*
 * This function executes the query to insert a single SaleObject into the database.
 * If the item doesn't exists in the database, assuming links are unique, it is inserted.
 * arguments:
 * 	object - SaleObject needed to be inserted
 * 	callback - Function to be called when insertion query is done execution
 *	count2 -  
 *	num - 
 */
function insertSingleItemIntoDatabase(object, connection) {
	if (object != null) {
		var sqlQuery = 'SELECT count(*) FROM apps WHERE link = ?';
		var query = connection.query(sqlQuery, [object.link]);
		Logger.log(0, "Executing query '" + query.sql + "'");
		var count = -1;
		query
		.on('result', function(row){
			count = row['count(*)'];	
		})
		.on('end', function() {
			if (count == 0) {
				//var link = crypto.createHash('md5').update(object.getLink()).digest('hex');
				var sqlQuery = "INSERT into apps (name, link, image, c1, c2, rating) values(?, ?, ?, ?, ?, ?)";
				var query = connection.query(sqlQuery, [object.getName(), object.getLink(), object.getImage(), object.getC1(), object.getC2(), object.getRating()]);
				Logger.log(0, "Executing query '" + query.sql + "'");
				query.on('end' ,function() {
					Logger.log(0, "Succesfully inserted item into the database");
					closeConnection(connection);
				});
			}
		});
	}
}


exports.insertSingleItemIntoDatabase = function(object) {
	
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			insertSingleItemIntoDatabase(object, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		insertSingleItemIntoDatabase(object, connection);
	}
};

/*
 * This function inserts SaleObjects from objects array into the database;
 * arguments:
 *	 objects - Array of SaleObjects
 */
function insertIntoDatabase(objects, connection) {
		for (var i = 0; i < objects.length; i++) {
			var object = objects[i];
			insertSingleItemIntoDatabase(object, connection);
		}
}

exports.insertIntoDatabase = function(objects) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			insertIntoDatabase(objects);
		});
	} else {
		var connection = connectToDatabase();
		insertIntoDatabase(objets, connection);
	}
};

/*
 * This function is for retrieving items from the database and load it into the passed objects array.
 */
function getObjectsFromDatabase(callback, connection) {
	var objects = new Array();
	var sqlQuery = 'SELECT * FROM apps ORDER BY name';	
	console.log(sqlQuery);
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row){
		var object = new AppObject(row['name'], row['link'], row['image'], row['c1'], row['c2'], row['rating']);
		objects.push(object);
	})
	.on('end', function() {
		closeConnection(connection);
		apps = new Array();
		if (objects.length != -1) {
			Logger.log(0, "Retrieved " + objects.length + " objects from the database");
			apps = objects;
		}else 
			Logger.log(-1, "Error retrieving");
		if(callback)
			callback(objects);
		
	});	
}

exports.getAllApps = function(callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			getObjectsFromDatabase(callback, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		getObjectsFromDatabase(callback, connection);
	}
};

function getAll(callback, connection) {
	var objects = new Array();
	var sqlQuery = 'SELECT * FROM apps ORDER BY name';	
	console.log(sqlQuery);
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row){
		var object = new AppObject(row['name'], row['link'], row['image'], row['c1'], row['c2'], row['rating']);
		objects.push(object);
	})
	.on('end', function() {});	
	var pendingApps = new Array();
	var sqlQuery = 'SELECT * FROM pendingApps ORDER BY name';	
	console.log(sqlQuery);
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row){
		var object = new AppObject(row['name'], row['link'], row['image'], row['c1'], row['c2'], row['rating']);
		object.setUser(row['user']);
		pendingApps.push(object);
	})
	.on('end', function() {
		closeConnection(connection);
		apps = new Array();
		if (objects.length != -1) {
			Logger.log(0, "Retrieved " + objects.length + " objects from the database");
			apps = pendingApps;
		}else 
			Logger.log(-1, "Error retrieving");
		if(callback)
			callback(objects, pendingApps);
		
	});	
}

exports.getAll = function(callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			getAll(callback, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		getAll(callback, connection);
	}
};
function getObjectsFromDatabaseWithResponse(objects, callback, response, connection) {
	var sqlQuery = 'SELECT * FROM SaleObjects ORDER BY dateAdded DESC';	
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row){
		var object = new SaleObject(row['title'], row['link'], row['description'], row['imageLink']);
		objects.push(object);
	})
	.on('end', function() {
		closeConnection(connection);
		if (objects.length != -1)
			Logger.log(0, "Retrieved " + objects.length + "objects from the database");
		else 
			Logger.log(-1, "Error retrieving");
		callback(objects, response);
	});
}

exports.getObjectsFromDatabaseWithResponse = function(objects, callback, response) {
	if (usePool) {
		pool.getConnection(function(err, poolConnection) {
			getObjectsFromDatabaseWithResponse(objects, callback, response, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		getObjectsFromDatabaseWithResponse(objects, callback, response, connection);
	}
};

/*
 * This function is for updating the database. Given the interval (24).
 * The items that were added more than the given interval, are deleted.
 */
function updateDatabase(callback, callback2, connection) {
	var count = -1;
	Logger.log(0, "Updating database");
	var sqlQuery = 'SELECT count(*) FROM SaleObjects WHERE dateAdded < DATE_SUB(NOW(), INTERVAL 24 HOUR)';
	sqlQuery = "SELECT * FROM SaleObjects";
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row) {
		count = row['count(*)'];
	})
	.on ('end', function() {
		if (count != 0) {
			if (callback2)
				deleteOldEntries(callback, callback2, connection);
			else
				deleteOldEntries(callback, null, connection);
		}else {
			Logger.log(0, 'No need to delete from database');
			closeConnection(connection);
			if (callback2 && callback)
				callback(callback2);
			else if (callback)
				callback();
			Logger.log(0, 'Done updating the database');
		}
		
	});
}
exports.updateDatabase = function(callback, callback2) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			updateDatabase(callback, callback2, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		updateDatabase(callback, callback2, connection);
	}
};

/*
 * This function is for deleting entries from the database that were added more than the given interval hours ago.
 */
function deleteOldEntries(callback, callback2, connection) {
	Logger.log(0, "Deleting from the database");
	var sqlQuery = 'DELETE FROM SaleObjects';
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('end', function() {
		closeConnection(connection);
		Logger.log(0, "Done deleting from database");
		// connection.end();
		Logger.log(0, 'Done updating the database');
		if (callback2 && callback)
			callback(callback2);
		else if (callback)
			callback();
		
	});
};

function closeConnection() {
	Logger.log(0,"Closing connection");
	if (connection != null) {
		connection.end();
		connectionMade = false;
	}
}

exports.closeConnection = function() {
	closeConnection();
};

exports.openConnection = function() {
	connectToDatabase();
};

function closeConnection(connection) {
	if (usePool) 
		connection.release();
	else 
		connection.end();	
}

function insertApp(object) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			insertSingleItemIntoDatabase(object, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		insertSingleItemIntoDatabase(object, connection);
	}
}

function updateRating(link, connection) {
	if (link != null) {
		var sqlQuery = 'SELECT count(*) FROM apps WHERE link = ?';
		var query = connection.query(sqlQuery, [link]);
		Logger.log(0, "Executing query '" + query.sql + "'");
		var count = -1;
		query
		.on('result', function(row){
			count = row['count(*)'];	
		})
		.on('end', function() {
			if (count != 0) {
				//var link = crypto.createHash('md5').update(object.getLink()).digest('hex');
				var sqlQuery = "UPDATE apps SET rating = rating + 1 WHERE link = ?";
				var query = connection.query(sqlQuery, [link]);
				query.on('end', function() {
					Logger.log(0, "Successfully update item");
					closeConnection(connection);
				});
			}
			updateArray();
		});
	}
}

//Should update the page as well
exports.updateRating = function(object) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			updateRating(object, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		updateRating(object, connection);
	}
}

function getApp(link) {
	var length = apps.length;
	for (var i = 0; i < length; i++) {
		if (apps[i].link == link)
			return apps[i];
	}
	return -1;
}

function updateArray() {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			getObjectsFromDatabase(null, poolConnection);
		});
	} else {
		var connection = connectToDatabase();
		getObjectsFromDatabase(null, connection);
	}
}

exports.getApp = function(link) {
	return getApp(link);
};

function login(connection, userDetails, callback) {
	var pass = crypto.createHash('md5').update(userDetails['password']).digest('hex');
	var sqlQuery = 'SELECT count(*), userType, liked FROM users WHERE username = ? AND password = ?';
	var query = connection.query(sqlQuery, [userDetails['username'], pass]);
	Logger.log(0, "Executing query '" + query.sql + "'");
	var count = -1;
	query
	.on('result', function(row){
		count = row['count(*)'];	
		userDetails['userType'] = row['userType'];
		userDetails['liked'] = row['liked'];
	})
	.on('end', function() {
		if(count > 0) {
			userDetails['password'] = "";
			console.log("Database functions", "Login successfull");
			if(callback) {
				callback['success'](userDetails);
			}
		}else {
			console.log("Database functions", "Login failure", 'count', count);
			if(callback) 
				callback['failure']();
		}
		closeConnection(connection);
	});
} 

exports.login = function(userDetails, callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			login(poolConnection, userDetails, callback);
		});
	} else {
		var connection = connectToDatabase();
		login(connection, userDetails, callback);
	}
};

function approveApp(connection, link, callback) {
	var object;
	var sqlQuery = 'SELECT * FROM pendingApps WHERE link = ?';
	var query = connection.query(sqlQuery, [link]);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row){
		object = new AppObject(row['name'], row['link'], row['image'], row['c1'], row['c2'], row['rating']);
	})
	.on('end', function() {
		insertSingleItemIntoDatabase(object, connection);
		deleteApp(link, callback);
	});	
	
}

exports.approveApp = function(link, callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			approveApp(poolConnection, link, callback);
		});
	} else {
		var connection = connectToDatabase();
		approveApp(connection, link, callback);
	}
};

//internal only
function deleteApp(link, callback) {
	var connection;
	if(usePool) 
		connection = poolConnection;
	else
		connection = connectToDatabase();
	var sqlQuery = "DELETE FROM pendingApps WHERE link = ?";
	var query = connection.query(sqlQuery, [link]);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('end', function() {
		closeConnection(connection);
		if(callback)
			callback();
	});	
}

exports.removeApp = function(link, callback) {
	deleteApp(link, callback);
};

function getUsers(connection, callback) {
	var users = new Array();
	var sqlQuery = "SELECT username FROM users";
	var query = connection.query(sqlQuery);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('result', function(row) {
		users.push(row['username']);
	})
	.on('end', function() {
		if(callback)
			callback(users);
	});
	
}

exports.getUsers = function(callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			getUsers(poolConnection, callback);
		});
	} else {
		var connection = connectToDatabase();
		getUsers(connection, callback);
	}
};

function addUser(connection, userDetails, callback) {
	var pass = crypto.createHash('md5').update(userDetails['password']).digest('hex');
	var sqlQuery = "INSERT INTO users (username, password, name, email) VALUES(?, ?, ?, ?)";
	var query = connection.query(sqlQuery, [userDetails['username'], pass, userDetails['name'], userDetails['email']]);
	Logger.log(0, "Executing query '" + query.sql + "'");
	query
	.on('end', function() {
		if(callback)
			callback();
	});
}

exports.addUser = function(userDetails, callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			addUser(poolConnection, userDetails, callback);
		});
	} else {
		var connection = connectToDatabase();
		addUser(connection, userDetails, callback);
	}
};

function insertSuggestedApp(connection, appDetails, callback) {
	if (appDetails != null) {
		var object = new AppObject(appDetails['name'], appDetails['link'], appDetails['image'], appDetails['c1'], appDetails['c2'], 0);
		object.setUser( appDetails['user']);
		var sqlQuery = "INSERT into pendingApps (name, link, image, c1, c2, rating, user) values(?, ?, ?, ?, ?, ?, ?)";
		var query = connection.query(sqlQuery, [object.getName(), object.getLink(), object.getImage(), object.getC1(), object.getC2(), object.getRating(), object.getUser()]);
		Logger.log(0, "Executing query '" + query.sql + "'");
		query
		.on('end', function() {
			Logger.log(0, "Succesfully inserted item into the database");
			closeConnection(connection);
		});
	}
}

exports.suggestApp = function(appDetails, callback) {
	if(usePool) {
		pool.getConnection(function(err, poolConnection) {
			insertSuggestedApp(poolConnection, appDetails, callback);
		});
	} else {
		var connection = connectToDatabase();
		insertSuggestedApp(connection, appDetails, callback);
	}
};

getConnectionDetails("./connection.cfg");
